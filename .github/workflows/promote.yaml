# Promotion Workflow
# Promotes releases between environments

name: Promote

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to promote (e.g., v1.0.0)'
        required: true
        type: string
      target:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - staging
          - production

jobs:
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.version }}

      - name: Verify tag exists
        run: git describe --tags --exact-match

      - name: Check target environment
        run: |
          if [ "${{ github.event.inputs.target }}" = "production" ]; then
            echo "::warning::Production promotion requires manual approval"
          fi

  promote-staging:
    name: Promote to Staging
    runs-on: ubuntu-latest
    needs: validate
    if: github.event.inputs.target == 'staging'
    environment: staging
    
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.version }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and tag images
        run: |
          for service in services/*/; do
            name=$(basename $service)
            docker build -t ghcr.io/jitterx69/inflow-$name:${{ github.event.inputs.version }} $service
          done

      - name: Verify Kustomize
        run: |
          kubectl kustomize infra/kubernetes/environments/staging

      - name: Record promotion
        run: |
          echo "Promoted ${{ github.event.inputs.version }} to staging at $(date -u)" >> CHANGELOG.md

  promote-production:
    name: Promote to Production
    runs-on: ubuntu-latest
    needs: validate
    if: github.event.inputs.target == 'production'
    environment: production
    
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.version }}

      - name: Require staging success
        run: |
          echo "Verifying staging deployment was successful..."
          # Check staging health endpoints
          
      - name: Build production images
        run: |
          for service in services/*/; do
            name=$(basename $service)
            docker build -t ghcr.io/jitterx69/inflow-$name:${{ github.event.inputs.version }} $service
          done

      - name: Verify production Kustomize
        run: |
          kubectl kustomize infra/kubernetes/environments/prod

      - name: Record promotion
        run: |
          echo "Promoted ${{ github.event.inputs.version }} to production at $(date -u)" >> CHANGELOG.md
