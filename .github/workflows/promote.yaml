# Promotion Workflow
# Promotes releases between environments

name: Promote

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to promote (e.g., v1.0.0)'
        required: true
        type: string
      target:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - staging
          - production

jobs:
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.version }}
          fetch-depth: 0

      - name: Verify tag exists
        run: |
          git fetch --tags
          git describe --tags --exact-match HEAD || echo "Warning: Not on exact tag"

      - name: Check target environment
        run: |
          if [ "${{ inputs.target }}" = "production" ]; then
            echo "::warning::Production promotion requires manual approval"
          fi

  promote-staging:
    name: Promote to Staging
    runs-on: ubuntu-latest
    needs: validate
    if: inputs.target == 'staging'
    # environment: staging  # Uncomment after creating environment in GitHub repo settings
    
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.version }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Build and tag images
        run: |
          for service in services/*/; do
            if [ -f "${service}Dockerfile" ]; then
              name=$(basename "$service")
              echo "Building $name..."
              docker build -t "ghcr.io/jitterx69/inflow-${name}:${{ inputs.version }}" "$service"
            fi
          done

      - name: Verify Kustomize
        run: |
          kubectl kustomize infra/kubernetes/environments/staging --enable-helm || true

      - name: Record promotion
        run: |
          echo "Promoted ${{ inputs.version }} to staging at $(date -u)" >> CHANGELOG.md

  promote-production:
    name: Promote to Production
    runs-on: ubuntu-latest
    needs: validate
    if: inputs.target == 'production'
    # environment: production  # Uncomment after creating environment in GitHub repo settings
    
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.version }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Require staging success
        run: |
          echo "Verifying staging deployment was successful..."
          # In production, add actual health checks here
          
      - name: Build production images
        run: |
          for service in services/*/; do
            if [ -f "${service}Dockerfile" ]; then
              name=$(basename "$service")
              echo "Building $name..."
              docker build -t "ghcr.io/jitterx69/inflow-${name}:${{ inputs.version }}" "$service"
            fi
          done

      - name: Verify production Kustomize
        run: |
          kubectl kustomize infra/kubernetes/environments/prod --enable-helm || true

      - name: Record promotion
        run: |
          echo "Promoted ${{ inputs.version }} to production at $(date -u)" >> CHANGELOG.md
